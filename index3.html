<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biz Center - AI Business Intelligence Assistant</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
      :root {
          --primary-bg: #0a0a0f;
          --secondary-bg: #1a1a2e;
          --tertiary-bg: #16213e;
          --card-bg: rgba(26, 26, 46, 0.8);
          --sidebar-bg: rgba(15, 15, 35, 0.95);
          --primary-blue: #3b82f6;
          --primary-blue-dark: #1d4ed8;
          --text-primary: #e2e8f0;
          --text-secondary: #64748b;
          --text-muted: #475569;
          --border-color: rgba(255, 255, 255, 0.1);
          --hover-bg: rgba(59, 130, 246, 0.1);
          --success-color: #10b981;
          --error-color: #ef4444;
          --warning-color: #f59e0b;
      }
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 50%, var(--tertiary-bg) 100%);
          color: var(--text-primary);
          height: 100vh;
          overflow: hidden;
          font-size: 14px;
          line-height: 1.6;
      }
      .container {
          display: flex;
          height: 100vh;
          position: relative;
      }
      /* Sidebar Styles */
      .sidebar {
          width: 300px;
          background: var(--sidebar-bg);
          backdrop-filter: blur(20px);
          border-right: 1px solid var(--border-color);
          padding: 18px;
          display: flex;
          flex-direction: column;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          position: relative;
          z-index: 100;
      }
      .sidebar::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(180deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
          pointer-events: none;
      }
      /* Ultra Compact Logo Container */
      .logo-container {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 20px;
          padding: 10px 14px;
          background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
          border-radius: 10px;
          box-shadow: 0 4px 16px rgba(59, 130, 246, 0.25);
          position: relative;
          overflow: hidden;
          min-height: 44px;
      }
      .logo-container::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(45deg, rgba(255, 255, 255, 0.08), transparent);
          pointer-events: none;
      }
      /* Compact Logo Icon */
      .logo-icon {
          font-size: 18px;
          color: white;
          text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
          width: 20px;
          text-align: center;
      }
      .logo-text {
          display: flex;
          flex-direction: column;
          flex: 1;
      }
      /* Compact Logo Title */
      .logo-title {
          font-size: 16px;
          font-weight: 700;
          color: white;
          text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
          letter-spacing: -0.2px;
          line-height: 1.1;
      }
      /* Compact Logo Subtitle */
      .logo-subtitle {
          font-size: 9px;
          color: rgba(255, 255, 255, 0.75);
          font-weight: 500;
          margin-top: 1px;
          line-height: 1.2;
      }
      .menu-section {
          margin-bottom: 22px;
      }
      .menu-section-title {
          font-size: 10px;
          font-weight: 700;
          color: var(--text-secondary);
          text-transform: uppercase;
          letter-spacing: 1px;
          margin-bottom: 12px;
          padding-left: 14px;
          position: relative;
      }
      .menu-section-title::before {
          content: '';
          position: absolute;
          left: 0;
          top: 50%;
          transform: translateY(-50%);
          width: 6px;
          height: 2px;
          background: var(--primary-blue);
          border-radius: 1px;
      }
      .menu-item {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 10px 14px;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          margin-bottom: 3px;
          position: relative;
          overflow: hidden;
          border: 1px solid transparent;
      }
      /* Moved vertical bar further inward */
      .menu-item::before {
          content: '';
          position: absolute;
          left: 10px;
          top: 0;
          bottom: 0;
          width: 0;
          background: linear-gradient(90deg, var(--primary-blue), transparent);
          transition: width 0.3s ease;
          border-radius: 0 1px 1px 0;
      }
      .menu-item:hover {
          background: var(--hover-bg);
          transform: translateX(3px);
          border-color: rgba(59, 130, 246, 0.2);
      }
      .menu-item:hover::before {
          width: 2px;
      }
      .menu-item.active {
          background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(29, 78, 216, 0.08));
          border-color: rgba(59, 130, 246, 0.3);
          box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
      }
      .menu-item.active::before {
          width: 2px;
      }
      .menu-item-icon {
          font-size: 15px;
          color: var(--text-secondary);
          width: 18px;
          text-align: center;
          transition: all 0.3s ease;
      }
      .menu-item.active .menu-item-icon,
      .menu-item:hover .menu-item-icon {
          color: var(--primary-blue);
          transform: scale(1.05);
      }
      .menu-item-text {
          font-size: 13px;
          font-weight: 500;
          color: var(--text-primary);
          transition: color 0.3s ease;
      }
      .menu-item-badge {
          margin-left: auto;
          background: var(--primary-blue);
          color: white;
          font-size: 9px;
          font-weight: 600;
          padding: 2px 5px;
          border-radius: 8px;
          min-width: 16px;
          text-align: center;
      }
      .stats-container {
          margin-top: auto;
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 8px;
      }
      .stats-card {
          background: rgba(255, 255, 255, 0.04);
          border-radius: 8px;
          padding: 10px;
          border: 1px solid var(--border-color);
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
      }
      .stats-card:hover {
          background: rgba(255, 255, 255, 0.06);
          transform: translateY(-1px);
      }
      .stats-title {
          font-size: 9px;
          color: var(--text-secondary);
          margin-bottom: 4px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.3px;
      }
      .stats-value {
          font-size: 16px;
          font-weight: 800;
          color: var(--primary-blue);
          line-height: 1;
      }
      .stats-trend {
          font-size: 8px;
          color: var(--success-color);
          margin-top: 2px;
          display: flex;
          align-items: center;
          gap: 2px;
      }
      /* History Panel Styles */
      .history-panel {
          position: fixed;
          top: 0;
          right: -400px;
          width: 400px;
          height: 100vh;
          background: var(--sidebar-bg);
          backdrop-filter: blur(20px);
          border-left: 1px solid var(--border-color);
          z-index: 1000;
          transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          display: flex;
          flex-direction: column;
      }
      .history-panel.open {
          right: 0;
      }
      .history-header {
          padding: 16px 18px;
          border-bottom: 1px solid var(--border-color);
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .history-title {
          font-size: 16px;
          font-weight: 700;
          color: var(--text-primary);
          display: flex;
          align-items: center;
          gap: 8px;
      }
      .history-close {
          background: none;
          border: none;
          color: var(--text-secondary);
          font-size: 16px;
          cursor: pointer;
          padding: 4px;
          border-radius: 4px;
          transition: all 0.3s ease;
          margin-left: auto;
      }
      .history-close:hover {
          background: var(--hover-bg);
          color: var(--text-primary);
      }
      .history-search {
          padding: 12px 18px;
          border-bottom: 1px solid var(--border-color);
      }
      .search-input {
          width: 100%;
          padding: 8px 12px;
          background: rgba(255, 255, 255, 0.06);
          border: 1px solid var(--border-color);
          border-radius: 6px;
          color: var(--text-primary);
          font-size: 12px;
          transition: all 0.3s ease;
      }
      .search-input:focus {
          outline: none;
          border-color: var(--primary-blue);
          box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      }
      .search-input::placeholder {
          color: var(--text-secondary);
      }
      .history-content {
          flex: 1;
          overflow-y: auto;
          padding: 12px 18px;
      }
      .history-content::-webkit-scrollbar {
          width: 4px;
      }
      .history-content::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.03);
          border-radius: 2px;
      }
      .history-content::-webkit-scrollbar-thumb {
          background: var(--primary-blue);
          border-radius: 2px;
      }
      .history-content::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(180deg, var(--primary-blue-dark), var(--primary-blue));
      }
      .history-section {
          margin-bottom: 16px;
      }
      .history-section-title {
          font-size: 10px;
          font-weight: 600;
          color: var(--text-secondary);
          text-transform: uppercase;
          letter-spacing: 0.8px;
          margin-bottom: 8px;
          padding-left: 4px;
      }
      .history-item {
          background: rgba(255, 255, 255, 0.04);
          border: 1px solid var(--border-color);
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 8px;
          cursor: pointer;
          transition: all 0.3s ease;
          position: relative;
      }
      .history-item:hover {
          background: rgba(255, 255, 255, 0.06);
          border-color: var(--primary-blue);
          transform: translateY(-1px);
      }
      .history-item.active {
          border-color: var(--primary-blue);
          background: rgba(59, 130, 246, 0.08);
      }
      .history-item-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 4px;
      }
      .history-item-title {
          font-size: 12px;
          font-weight: 600;
          color: var(--text-primary);
          line-height: 1.2;
          flex: 1;
          margin-right: 8px;
      }
      .history-item-time {
          font-size: 9px;
          color: var(--text-secondary);
          white-space: nowrap;
      }
      .history-item-preview {
          font-size: 10px;
          color: var(--text-secondary);
          line-height: 1.2;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
      }
      .history-item-stats {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-top: 8px;
          padding-top: 8px;
          border-top: 1px solid var(--border-color);
      }
      .history-item-count {
          font-size: 9px;
          color: var(--text-secondary);
          display: flex;
          align-items: center;
          gap: 2px;
      }
      .history-item-actions {
          display: flex;
          gap: 4px;
      }
      .history-action-btn {
          background: none;
          border: none;
          color: var(--text-secondary);
          font-size: 10px;
          cursor: pointer;
          padding: 2px 4px;
          border-radius: 3px;
          transition: all 0.3s ease;
      }
      .history-action-btn:hover {
          background: var(--hover-bg);
          color: var(--primary-blue);
      }
      .history-empty {
          text-align: center;
          padding: 24px 14px;
          color: var(--text-secondary);
      }
      .history-empty i {
          font-size: 32px;
          margin-bottom: 10px;
          opacity: 0.4;
      }
      .history-empty h3 {
          font-size: 13px;
          margin-bottom: 4px;
          color: var(--text-primary);
      }
      .history-empty p {
          font-size: 11px;
          line-height: 1.3;
      }
      .history-actions {
          padding: 12px 18px;
          border-top: 1px solid var(--border-color);
          display: flex;
          gap: 8px;
      }
      .history-btn {
          flex: 1;
          padding: 6px 10px;
          background: rgba(255, 255, 255, 0.08);
          border: 1px solid var(--border-color);
          border-radius: 5px;
          color: var(--text-primary);
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 11px;
          font-weight: 500;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 4px;
      }
      .history-btn:hover {
          background: var(--hover-bg);
          border-color: var(--primary-blue);
      }
      .history-btn.danger:hover {
          background: rgba(239, 68, 68, 0.08);
          border-color: var(--error-color);
          color: var(--error-color);
      }
      /* Main Content Styles */
      .main-content {
          flex: 1;
          display: flex;
          flex-direction: column;
          background: var(--card-bg);
          backdrop-filter: blur(20px);
          position: relative;
      }
      .main-content::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background:
              radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
              radial-gradient(circle at 80% 80%, rgba(29, 78, 216, 0.08) 0%, transparent 50%);
          pointer-events: none;
      }
      /* Ultra Compact Header */
      .header {
          padding: 12px 24px;
          border-bottom: 1px solid var(--border-color);
          background: rgba(15, 15, 35, 0.9);
          backdrop-filter: blur(20px);
          position: relative;
          z-index: 10;
          min-height: 60px;
      }
      .header-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .header-left {
          display: flex;
          align-items: center;
          gap: 12px;
      }
      .mobile-menu-btn {
          display: none;
          background: none;
          border: none;
          color: var(--text-primary);
          font-size: 16px;
          cursor: pointer;
          padding: 4px;
          border-radius: 4px;
          transition: all 0.3s ease;
      }
      .mobile-menu-btn:hover {
          background: var(--hover-bg);
      }
      /* Compact Header Title */
      .header-title {
          font-size: 20px;
          font-weight: 700;
          color: var(--text-primary);
          background: linear-gradient(135deg, var(--text-primary), var(--primary-blue));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          letter-spacing: -0.3px;
          line-height: 1.1;
      }
      .header-subtitle {
          font-size: 11px;
          color: var(--text-secondary);
          margin-top: 1px;
          font-weight: 500;
          line-height: 1.2;
      }
      .header-actions {
          display: flex;
          gap: 8px;
          align-items: center;
      }
      .action-btn {
          padding: 6px 10px;
          background: rgba(255, 255, 255, 0.08);
          border: 1px solid var(--border-color);
          border-radius: 6px;
          color: var(--text-primary);
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          font-size: 11px;
          font-weight: 500;
          display: flex;
          align-items: center;
          gap: 4px;
          backdrop-filter: blur(10px);
      }
      .action-btn:hover {
          background: var(--hover-bg);
          border-color: var(--primary-blue);
          transform: translateY(-1px);
          box-shadow: 0 2px 6px rgba(59, 130, 246, 0.15);
      }
      .status-indicator {
          display: flex;
          align-items: center;
          gap: 4px;
          padding: 4px 8px;
          background: rgba(16, 185, 129, 0.08);
          border: 1px solid rgba(16, 185, 129, 0.2);
          border-radius: 12px;
          font-size: 10px;
          font-weight: 600;
          color: var(--success-color);
      }
      .status-dot {
          width: 5px;
          height: 5px;
          background: var(--success-color);
          border-radius: 50%;
          animation: pulse 2s infinite;
      }
      @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
      }
      /* Chat Container Styles */
      .chat-container {
          flex: 1;
          display: flex;
          flex-direction: column;
          padding: 18px 24px;
          overflow: hidden;
          position: relative;
          z-index: 1;
      }
      .chat-messages {
          flex: 1;
          overflow-y: auto;
          padding: 14px 0;
          scroll-behavior: smooth;
          position: relative;
      }
      .chat-messages::-webkit-scrollbar {
          width: 5px;
      }
      .chat-messages::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.03);
          border-radius: 2px;
      }
      .chat-messages::-webkit-scrollbar-thumb {
          background: linear-gradient(180deg, var(--primary-blue), var(--primary-blue-dark));
          border-radius: 2px;
      }
      .chat-messages::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(180deg, var(--primary-blue-dark), var(--primary-blue));
      }
      /* Message Styles */
      .message {
          display: flex;
          margin-bottom: 18px;
          animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          position: relative;
      }
      @keyframes fadeInUp {
          from {
              opacity: 0;
              transform: translateY(12px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }
      .message.user {
          justify-content: flex-end;
      }
      .message-content {
          max-width: 75%;
          display: flex;
          align-items: flex-start;
          gap: 8px;
      }
      .message.user .message-content {
          flex-direction: row-reverse;
      }
      .avatar {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 14px;
          flex-shrink: 0;
          position: relative;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }
      .avatar::before {
          content: '';
          position: absolute;
          inset: -1px;
          border-radius: 50%;
          padding: 1px;
          background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
          mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
          mask-composite: exclude;
      }
      .avatar.user {
          background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
          color: white;
      }
      .avatar.bot {
          background: linear-gradient(135deg, var(--text-secondary), var(--text-muted));
          color: white;
      }
      .bubble {
          padding: 12px 16px;
          border-radius: 14px;
          font-size: 13px;
          line-height: 1.4;
          position: relative;
          backdrop-filter: blur(10px);
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
          word-wrap: break-word;
      }
      .message.user .bubble {
          background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
          color: white;
          border-bottom-right-radius: 4px;
          box-shadow: 0 4px 16px rgba(59, 130, 246, 0.25);
      }
      .message.bot .bubble {
          background: rgba(255, 255, 255, 0.06);
          color: var(--text-primary);
          border: 1px solid var(--border-color);
          border-bottom-left-radius: 4px;
      }
      .bubble strong {
          font-weight: 700;
          color: inherit;
      }
      .bubble table {
          width: 100%;
          border-collapse: collapse;
          margin: 10px 0;
          background: rgba(0, 0, 0, 0.15);
          border-radius: 6px;
          overflow: hidden;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }
      .bubble th,
      .bubble td {
          padding: 6px 10px;
          text-align: left;
          border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .bubble th {
          background: rgba(59, 130, 246, 0.15);
          font-weight: 700;
          color: var(--primary-blue);
          font-size: 11px;
          text-transform: uppercase;
          letter-spacing: 0.3px;
      }
      .bubble td {
          font-size: 12px;
      }
      .bubble tr:last-child td {
          border-bottom: none;
      }
      .bubble tr:nth-child(even) td {
          background: rgba(255, 255, 255, 0.02);
      }
      /* Image in bubble */
      .bubble img {
          max-width: 100%;
          height: auto;
          border-radius: 8px;
          margin-top: 10px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
          border: 1px solid var(--border-color);
      }
      /* Welcome Message */
      .welcome-message {
          text-align: center;
          padding: 40px 28px;
          color: var(--text-secondary);
          position: relative;
      }
      .welcome-message::before {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 140px;
          height: 140px;
          background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
          border-radius: 50%;
          z-index: -1;
      }
      .welcome-icon {
          font-size: 44px;
          color: var(--primary-blue);
          margin-bottom: 16px;
          text-shadow: 0 2px 12px rgba(59, 130, 246, 0.25);
      }
      .welcome-title {
          font-size: 22px;
          margin-bottom: 8px;
          color: var(--text-primary);
          font-weight: 700;
          background: linear-gradient(135deg, var(--text-primary), var(--primary-blue));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
      }
      .welcome-description {
          font-size: 13px;
          line-height: 1.5;
          max-width: 400px;
          margin: 0 auto;
          color: var(--text-secondary);
      }
      .welcome-features {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
          gap: 14px;
          margin-top: 28px;
          max-width: 480px;
          margin-left: auto;
          margin-right: auto;
      }
      .welcome-feature {
          padding: 14px;
          background: rgba(255, 255, 255, 0.04);
          border-radius: 8px;
          border: 1px solid var(--border-color);
          text-align: center;
          transition: all 0.3s ease;
      }
      .welcome-feature:hover {
          background: rgba(255, 255, 255, 0.06);
          transform: translateY(-2px);
      }
      .welcome-feature i {
          font-size: 18px;
          color: var(--primary-blue);
          margin-bottom: 8px;
      }
      .welcome-feature h4 {
          font-size: 12px;
          font-weight: 600;
          color: var(--text-primary);
          margin-bottom: 4px;
      }
      .welcome-feature p {
          font-size: 10px;
          color: var(--text-secondary);
          line-height: 1.3;
      }
      /* Ultra Compact Input Area */
      .input-area {
          padding: 10px 0;
          border-top: 1px solid var(--border-color);
          background: rgba(15, 15, 35, 0.6);
          backdrop-filter: blur(20px);
      }
      .input-container {
          display: flex;
          gap: 8px;
          align-items: flex-end;
          position: relative;
      }
      .input-wrapper {
          flex: 1;
          position: relative;
      }
      .input-actions {
          position: absolute;
          right: 8px;
          bottom: 8px;
          display: flex;
          gap: 4px;
          z-index: 10;
      }
      .input-action-btn {
          width: 24px;
          height: 24px;
          border-radius: 4px;
          border: none;
          background: rgba(255, 255, 255, 0.08);
          color: var(--text-secondary);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.3s ease;
          font-size: 11px;
      }
      .input-action-btn:hover {
          background: var(--hover-bg);
          color: var(--primary-blue);
      }
      /* Ultra Compact Input */
      #messageInput {
          width: 100%;
          padding: 8px 80px 8px 12px;
          background: rgba(255, 255, 255, 0.06);
          border: 1px solid var(--border-color);
          border-radius: 8px;
          color: var(--text-primary);
          font-size: 13px;
          resize: none;
          min-height: 36px;
          max-height: 100px;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          font-family: inherit;
          line-height: 1.3;
      }
      #messageInput:focus {
          outline: none;
          border-color: var(--primary-blue);
          box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.08);
          background: rgba(255, 255, 255, 0.08);
      }
      #messageInput::placeholder {
          color: var(--text-secondary);
          font-weight: 400;
      }
      /* Ultra Compact Send Button */
      .send-btn {
          padding: 8px 14px;
          background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
          border: none;
          border-radius: 8px;
          color: white;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          display: flex;
          align-items: center;
          justify-content: center;
          min-width: 36px;
          font-size: 13px;
          font-weight: 600;
          box-shadow: 0 4px 16px rgba(59, 130, 246, 0.25);
          position: relative;
          overflow: hidden;
      }
      .send-btn::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
          transition: left 0.5s;
      }
      .send-btn:hover::before {
          left: 100%;
      }
      .send-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 6px 20px rgba(59, 130, 246, 0.35);
      }
      .send-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          transform: none;
          box-shadow: 0 2px 6px rgba(59, 130, 246, 0.15);
      }
      .send-btn:disabled:hover {
          transform: none;
      }
      /* Stop Generation Button */
      .stop-btn {
          padding: 8px 14px;
          background: linear-gradient(135deg, var(--error-color), #dc2626);
          border: none;
          border-radius: 8px;
          color: white;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          min-width: 36px;
          font-size: 11px;
          font-weight: 600;
          box-shadow: 0 4px 16px rgba(239, 68, 68, 0.25);
          position: relative;
          overflow: hidden;
      }
      .stop-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
          background: linear-gradient(135deg, #dc2626, var(--error-color));
      }
      .stop-btn::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
          transition: left 0.5s;
      }
      .stop-btn:hover::before {
          left: 100%;
      }
      .stop-icon {
          width: 8px;
          height: 8px;
          background: white;
          border-radius: 1px;
      }
      /* Loading Animation */
      .loading-message {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 10px 0;
      }
      .loading-dots {
          display: flex;
          gap: 3px;
          align-items: center;
      }
      .loading-dot {
          width: 6px;
          height: 6px;
          background: var(--text-secondary);
          border-radius: 50%;
          animation: loadingDots 1.4s infinite ease-in-out;
      }
      .loading-dot:nth-child(1) { animation-delay: -0.32s; }
      .loading-dot:nth-child(2) { animation-delay: -0.16s; }
      .loading-dot:nth-child(3) { animation-delay: 0s; }
      @keyframes loadingDots {
          0%, 80%, 100% {
              transform: scale(0.8);
              opacity: 0.5;
          }
          40% {
              transform: scale(1.2);
              opacity: 1;
          }
      }
      .loading-text {
          color: var(--text-secondary);
          font-size: 12px;
          font-weight: 500;
      }
      /* Responsive Design */
      @media (max-width: 1024px) {
          .sidebar {
              width: 260px;
              padding: 16px;
          }
          .header {
              padding: 10px 20px;
          }
          .chat-container {
              padding: 14px 20px;
          }
          .history-panel {
              width: 300px;
          }
      }
      @media (max-width: 768px) {
          .sidebar {
              width: 260px;
              transform: translateX(-100%);
              position: fixed;
              height: 100vh;
              z-index: 1000;
              box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
          }
          .sidebar.open {
              transform: translateX(0);
          }
          .main-content {
              margin-left: 0;
          }
          .mobile-menu-btn {
              display: block;
          }
          .header-title {
              font-size: 18px;
          }
          .header-actions {
              gap: 6px;
          }
          .action-btn {
              padding: 4px 8px;
              font-size: 10px;
          }
          .action-btn span {
              display: none;
          }
          .chat-container {
              padding: 10px 14px;
          }
          .message-content {
              max-width: 85%;
          }
          .bubble {
              padding: 10px 14px;
              font-size: 12px;
          }
          .welcome-message {
              padding: 28px 14px;
          }
          .welcome-title {
              font-size: 18px;
          }
          .welcome-description {
              font-size: 12px;
          }
          .welcome-features {
              grid-template-columns: 1fr;
              gap: 10px;
          }
          #messageInput {
              padding: 6px 70px 6px 10px;
              font-size: 12px;
              min-height: 32px;
          }
          .send-btn {
              padding: 6px 12px;
              min-width: 32px;
          }
          .history-panel {
              width: 100%;
              right: -100%;
          }
      }
      @media (max-width: 480px) {
          .sidebar {
              width: 100%;
              padding: 14px;
          }
          .header {
              padding: 8px 14px;
          }
          .chat-container {
              padding: 8px 12px;
          }
          .message-content {
              max-width: 90%;
          }
          .avatar {
              width: 28px;
              height: 28px;
              font-size: 12px;
          }
          .bubble {
              padding: 8px 12px;
              font-size: 11px;
          }
          .welcome-message {
              padding: 20px 10px;
          }
          .welcome-icon {
              font-size: 36px;
          }
          .welcome-title {
              font-size: 16px;
          }
          .stats-container {
              grid-template-columns: 1fr;
          }
          .logo-container {
              padding: 8px 12px;
              min-height: 40px;
          }
          .logo-title {
              font-size: 14px;
          }
          .logo-subtitle {
              font-size: 8px;
          }
      }
      /* Overlay for mobile sidebar */
      .sidebar-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.4);
          z-index: 999;
          backdrop-filter: blur(3px);
      }
      .sidebar-overlay.active {
          display: block;
      }
      /* History overlay */
      .history-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.4);
          z-index: 999;
          backdrop-filter: blur(3px);
      }
      .history-overlay.active {
          display: block;
      }
      /* Notification Styles */
      .notification {
          position: fixed;
          top: 12px;
          right: 12px;
          padding: 10px 14px;
          background: var(--success-color);
          color: white;
          border-radius: 6px;
          box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
          z-index: 10000;
          transform: translateX(300px);
          transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          font-weight: 600;
          font-size: 12px;
      }
      .notification.show {
          transform: translateX(0);
      }
      .notification.error {
          background: var(--error-color);
          box-shadow: 0 44px 16px rgba(239, 68, 68, 0.25);
      }
      .notification.info {
          background: var(--primary-blue);
          box-shadow: 0 4px 16px rgba(59, 130, 246, 0.25);
      }
      /* Typing indicator */
      .typing-indicator {
          display: flex;
          align-items: center;
          gap: 4px;
          padding: 8px 0;
          color: var(--text-secondary);
          font-size: 11px;
          font-style: italic;
      }
      .typing-indicator .loading-dots {
          gap: 2px;
      }
      .typing-indicator .loading-dot {
          width: 4px;
          height: 4px;
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- Sidebar Overlay for Mobile -->
      <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
      <!-- History Overlay -->
      <div class="history-overlay" id="historyOverlay" onclick="closeHistoryPanel()"></div>
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
          <div class="logo-container">
              <i class="fas fa-building logo-icon"></i>
              <div class="logo-text">
                  <div class="logo-title">Biz Center</div>
                  <div class="logo-subtitle">AI Business Intelligence</div>
              </div>
          </div>
          <div class="menu-section">
              <div class="menu-section-title">Main</div>
              <div class="menu-item active" onclick="setActiveMenu(this, 'chat')">
                  <i class="fas fa-comments menu-item-icon"></i>
                  <span class="menu-item-text">Chat Assistant</span>
              </div>
              <div class="menu-item" onclick="setActiveMenu(this, 'analytics')">
                  <i class="fas fa-chart-line menu-item-icon"></i>
                  <span class="menu-item-text">Analytics</span>
                  <span class="menu-item-badge">Pro</span>
              </div>
              <div class="menu-item" onclick="setActiveMenu(this, 'knowledge')">
                  <i class="fas fa-database menu-item-icon"></i>
                  <span class="menu-item-text">Knowledge Base</span>
              </div>
              <div class="menu-item" onclick="setActiveMenu(this, 'insights')">
                  <i class="fas fa-lightbulb menu-item-icon"></i>
                  <span class="menu-item-text">AI Insights</span>
              </div>
          </div>
          <div class="menu-section">
              <div class="menu-section-title">Tools</div>
              <div class="menu-item" onclick="setActiveMenu(this, 'upload')">
                  <i class="fas fa-file-upload menu-item-icon"></i>
                  <span class="menu-item-text">Upload Documents</span>
              </div>
              <div class="menu-item" onclick="setActiveMenu(this, 'export')">
                  <i class="fas fa-download menu-item-icon"></i>
                  <span class="menu-item-text">Export Data</span>
              </div>
              <div class="menu-item" onclick="setActiveMenu(this, 'history')">
                  <i class="fas fa-history menu-item-icon"></i>
                  <span class="menu-item-text">Chat History</span>
                  <span class="menu-item-badge" id="historyBadge">0</span>
              </div>
              <div class="menu-item" onclick="setActiveMenu(this, 'integrations')">
                  <i class="fas fa-plug menu-item-icon"></i>
                  <span class="menu-item-text">Integrations</span>
              </div>
          </div>
          <div class="menu-section">
              <div class="menu-section-title">Settings</div>
              <div class="menu-item" onclick="setActiveMenu(this, 'preferences')">
                  <i class="fas fa-cog menu-item-icon"></i>
                  <span class="menu-item-text">Preferences</span>
              </div>
              <div class="menu-item" onclick="setActiveMenu(this, 'profile')">
                  <i class="fas fa-user menu-item-icon"></i>
                  <span class="menu-item-text">Profile</span>
              </div>
              <div class="menu-item" onclick="setActiveMenu(this, 'help')">
                  <i class="fas fa-question-circle menu-item-icon"></i>
                  <span class="menu-item-text">Help & Support</span>
              </div>
          </div>
          <div class="stats-container">
              <div class="stats-card">
                  <div class="stats-title">Messages</div>
                  <div class="stats-value" id="messageCount">0</div>
                  <div class="stats-trend">
                      <i class="fas fa-arrow-up"></i>
                      <span>Today</span>
                  </div>
              </div>
              <div class="stats-card">
                  <div class="stats-title">Sessions</div>
                  <div class="stats-value" id="sessionCount">0</div>
                  <div class="stats-trend">
                      <i class="fas fa-arrow-up"></i>
                      <span>Total</span>
                  </div>
              </div>
          </div>
      </div>
      <!-- History Panel -->
      <div class="history-panel" id="historyPanel">
          <div class="history-header">
              <div class="history-title">
                  <i class="fas fa-history"></i>
                  Chat History
              </div>
              <button class="history-close" onclick="closeHistoryPanel()">
                  <i class="fas fa-times"></i>
              </button>
          </div>
          <div class="history-search">
              <input type="text" class="search-input" id="historySearch" placeholder="Search conversations..." oninput="searchHistory()">
          </div>
          <div class="history-content" id="historyContent">
              <div class="history-empty">
                  <i class="fas fa-comments"></i>
                  <h3>No Chat History</h3>
                  <p>Start a conversation to see your chat history here. All conversations are stored locally on your device.</p>
              </div>
          </div>
          <div class="history-actions">
              <button class="history-btn" onclick="exportAllHistory()">
                  <i class="fas fa-download"></i>
                  Export All
              </button>
              <button class="history-btn danger" onclick="clearAllHistory()">
                  <i class="fas fa-trash"></i>
                  Clear All
              </button>
          </div>
      </div>
      <!-- Main Content -->
      <div class="main-content">
          <div class="header">
              <div class="header-content">
                  <div class="header-left">
                      <button class="mobile-menu-btn" onclick="toggleSidebar()">
                          <i class="fas fa-bars"></i>
                      </button>
                      <div>
                          <div class="header-title">AI Business Assistant</div>
                          <div class="header-subtitle">Get intelligent insights and answers for your business</div>
                      </div>
                  </div>
                  <div class="header-actions">
                      <div class="status-indicator">
                          <div class="status-dot"></div>
                          <span>Online</span>
                      </div>
                      <button class="action-btn" onclick="newChat()">
                          <i class="fas fa-plus"></i>
                          <span>New Chat</span>
                      </button>
                      <button class="action-btn" onclick="openHistoryPanel()">
                          <i class="fas fa-history"></i>
                          <span>History</span>
                      </button>
                      <button class="action-btn" onclick="exportChat()">
                          <i class="fas fa-download"></i>
                          <span>Export</span>
                      </button>
                      <button class="action-btn" onclick="toggleSettings()">
                          <i class="fas fa-cog"></i>
                          <span>Settings</span>
                      </button>
                  </div>
              </div>
          </div>
          <div class="chat-container">
              <div class="chat-messages" id="chatMessages">
                  <div class="welcome-message">
                      <i class="fas fa-robot welcome-icon"></i>
                      <h3 class="welcome-title">Welcome to Biz Center</h3>
                      <p class="welcome-description">
                          Your AI-powered business intelligence assistant is ready to help you make data-driven decisions,
                          analyze trends, and get insights from your business data.
                      </p>
                      <div class="welcome-features">
                          <div class="welcome-feature">
                              <i class="fas fa-chart-bar"></i>
                              <h4>Data Analysis</h4>
                              <p>Analyze your business metrics and KPIs</p>
                          </div>
                          <div class="welcome-feature">
                              <i class="fas fa-brain"></i>
                              <h4>AI Insights</h4>
                              <p>Get intelligent recommendations</p>
                          </div>
                          <div class="welcome-feature">
                              <i class="fas fa-search"></i>
                              <h4>Smart Search</h4>
                              <p>Find information across your data</p>
                          </div>
                      </div>
                  </div>
              </div>
              <div class="input-area">
                  <div class="input-container">
                      <div class="input-wrapper">
                          <textarea
                               id="messageInput"
                               placeholder="Ask me anything about your business data, analytics, or get insights..."
                              rows="1"
                          ></textarea>
                          <div class="input-actions">
                              <button class="input-action-btn" onclick="attachFile()" title="Attach file">
                                  <i class="fas fa-paperclip"></i>
                              </button>
                              <button class="input-action-btn" onclick="toggleVoice()" title="Voice input">
                                  <i class="fas fa-microphone"></i>
                              </button>
                          </div>
                      </div>
                      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                          <i class="fas fa-paper-plane"></i>
                      </button>
                  </div>
              </div>
          </div>
      </div>
  </div>
  <!-- Notification Container -->
  <div id="notificationContainer"></div>
  <div id="recordingStatus" style="position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%); background: rgba(59, 130, 246, 0.9); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; display: none; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
      <i class="fas fa-microphone-alt"></i>
      <span>Recording...</span>
  </div>
  <script>
      // Global variables
      let messageCount = 0;
      let sessionCount = 0;
      let isLoading = false;
      let currentActiveMenu = 'chat';
      let currentSessionId = null;
      let chatHistory = [];
      let currentMessages = [];
      let abortController = null;
      let mediaRecorder;
      let audioChunks = [];
      let isRecording = false;
      let recordingStatusElement; // To display recording status

      // Initialize the application
      document.addEventListener('DOMContentLoaded', function() {
          initializeApp();
      });

      function initializeApp() {
          setupEventListeners();
          loadStoredData();
          createNewSession();
          showWelcomeMessage();
          updateHistoryBadge();
          recordingStatusElement = document.getElementById('recordingStatus'); // Add this line
      }

      function setupEventListeners() {
          const messageInput = document.getElementById('messageInput');

          // Auto-resize textarea
          messageInput.addEventListener('input', function() {
              this.style.height = 'auto';
              this.style.height = Math.min(this.scrollHeight, 100) + 'px';
          });
          // Send message on Enter (but not Shift+Enter)
          messageInput.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' && !e.shiftKey) {
                  e.preventDefault();
                  sendMessage();
              }
          });
          // Close sidebar when clicking outside on mobile
          document.addEventListener('click', function(e) {
              const sidebar = document.getElementById('sidebar');
              const mobileMenuBtn = document.querySelector('.mobile-menu-btn');

              if (window.innerWidth <= 768 &&
                  !sidebar.contains(e.target) &&
                  !mobileMenuBtn.contains(e.target) &&
                  sidebar.classList.contains('open')) {
                  closeSidebar();
              }
          });
          // Handle window resize
          window.addEventListener('resize', function() {
              if (window.innerWidth > 768) {
                  closeSidebar();
                  closeHistoryPanel();
              }
          });
      }

      function loadStoredData() {
          // Load stored message and session counts
          const storedMessageCount = localStorage.getItem('bizCenter_messageCount');
          const storedSessionCount = localStorage.getItem('bizCenter_sessionCount');
          const storedHistory = localStorage.getItem('bizCenter_chatHistory');

          if (storedMessageCount) {
              messageCount = parseInt(storedMessageCount);
              document.getElementById('messageCount').textContent = messageCount;
          }

          if (storedSessionCount) {
              sessionCount = parseInt(storedSessionCount);
              document.getElementById('sessionCount').textContent = sessionCount;
          }
          if (storedHistory) {
              try {
                  chatHistory = JSON.parse(storedHistory);
              } catch (e) {
                  chatHistory = [];
              }
          }
      }

      function saveData() {
          localStorage.setItem('bizCenter_messageCount', messageCount.toString());
          localStorage.setItem('bizCenter_sessionCount', sessionCount.toString());
          localStorage.setItem('bizCenter_chatHistory', JSON.stringify(chatHistory));
      }

      // Session Management
      function createNewSession() {
          currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          currentMessages = [];

          const newSession = {
              id: currentSessionId,
              title: 'New Conversation',
              messages: [],
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
              messageCount: 0
          };

          chatHistory.unshift(newSession);
          sessionCount++;
          document.getElementById('sessionCount').textContent = sessionCount;
          saveData();
          updateHistoryBadge();
      }

      function updateCurrentSession() {
          const sessionIndex = chatHistory.findIndex(session => session.id === currentSessionId);
          if (sessionIndex !== -1) {
              chatHistory[sessionIndex].messages = [...currentMessages];
              chatHistory[sessionIndex].updatedAt = new Date().toISOString();
              chatHistory[sessionIndex].messageCount = currentMessages.length;

              // Update title based on first user message
              if (currentMessages.length > 0) {
                  const firstUserMessage = currentMessages.find(msg => msg.role === 'user');
                  if (firstUserMessage) {
                      const title = firstUserMessage.content.substring(0, 50);
                      chatHistory[sessionIndex].title = title.length < firstUserMessage.content.length ? title + '...' : title;
                  }
              }

              saveData();
              updateHistoryDisplay();
          }
      }

      function loadSession(sessionId) {
          const session = chatHistory.find(s => s.id === sessionId);
          if (session) {
              currentSessionId = sessionId;
              currentMessages = [...session.messages];

              // Clear current chat and load session messages
              const chatMessages = document.getElementById('chatMessages');
              chatMessages.innerHTML = '';

              currentMessages.forEach(message => {
                  // Check if message has image data
                  if (message.chart_image) {
                      appendImageMessage(message.chart_image, message.content, false); // Use message.content for description
                  } else {
                      appendMessage(message.role, message.content, false, false);
                  }
              });

              // Mark session as active in history
              updateHistoryDisplay();
              closeHistoryPanel();
              showNotification('Session loaded successfully', 'success');
          }
      }

      function deleteSession(sessionId) {
          const sessionIndex = chatHistory.findIndex(s => s.id === sessionId);
          if (sessionIndex !== -1) {
              chatHistory.splice(sessionIndex, 1);
              sessionCount--;
              document.getElementById('sessionCount').textContent = sessionCount;
              saveData();
              updateHistoryDisplay();
              updateHistoryBadge();

              // If deleted session was current, create new one
              if (sessionId === currentSessionId) {
                  newChat();
              }

              showNotification('Session deleted', 'success');
          }
      }

      function newChat() {
          // Save current session if it has messages
          if (currentMessages.length > 0) {
              updateCurrentSession();
          } else {
              // Remove empty session
              const emptySessionIndex = chatHistory.findIndex(s => s.id === currentSessionId);
              if (emptySessionIndex !== -1) {
                  chatHistory.splice(emptySessionIndex, 1);
              }
          }

          // Clear current chat
          const chatMessages = document.getElementById('chatMessages');
          chatMessages.innerHTML = `
              <div class="welcome-message">
                  <i class="fas fa-robot welcome-icon"></i>
                  <h3 class="welcome-title">Welcome to Biz Center</h3>
                  <p class="welcome-description">
                      Your AI-powered business intelligence assistant is ready to help you make data-driven decisions,
                      analyze trends, and get insights from your business data.
                  </p>
                  <div class="welcome-features">
                      <div class="welcome-feature">
                          <i class="fas fa-chart-bar"></i>
                          <h4>Data Analysis</h4>
                          <p>Analyze your business metrics and KPIs</p>
                      </div>
                      <div class="welcome-feature">
                          <i class="fas fa-brain"></i>
                          <h4>AI Insights</h4>
                          <p>Get intelligent recommendations</p>
                      </div>
                      <div class="welcome-feature">
                          <i class="fas fa-search"></i>
                          <h4>Smart Search</h4>
                          <p>Find information across your data</p>
                      </div>
                  </div>
              </div>
          `;

          createNewSession();
          showWelcomeMessage();
          showNotification('New chat started', 'success');
      }

      // History Management
      function openHistoryPanel() {
          const historyPanel = document.getElementById('historyPanel');
          const historyOverlay = document.getElementById('historyOverlay');

          historyPanel.classList.add('open');
          historyOverlay.classList.add('active');

          updateHistoryDisplay();
      }

      function closeHistoryPanel() {
          const historyPanel = document.getElementById('historyPanel');
          const historyOverlay = document.getElementById('historyOverlay');

          historyPanel.classList.remove('open');
          historyOverlay.classList.remove('active');
      }

      function updateHistoryDisplay() {
          const historyContent = document.getElementById('historyContent');

          if (chatHistory.length === 0) {
              historyContent.innerHTML = `
                  <div class="history-empty">
                      <i class="fas fa-comments"></i>
                      <h3>No Chat History</h3>
                      <p>Start a conversation to see your chat history here. All conversations are stored locally on your device.</p>
                  </div>
              `;
              return;
          }
          // Group sessions by date
          const groupedSessions = groupSessionsByDate(chatHistory);

          let historyHTML = '';

          Object.keys(groupedSessions).forEach(dateGroup => {
              historyHTML += `<div class="history-section">`;
              historyHTML += `<div class="history-section-title">${dateGroup}</div>`;

              groupedSessions[dateGroup].forEach(session => {
                  const isActive = session.id === currentSessionId;
                  const timeAgo = getTimeAgo(new Date(session.updatedAt));
                  const preview = getSessionPreview(session);

                  historyHTML += `
                      <div class="history-item ${isActive ? 'active' : ''}" onclick="loadSession('${session.id}')">
                          <div class="history-item-header">
                              <div class="history-item-title">${session.title}</div>
                              <div class="history-item-time">${timeAgo}</div>
                          </div>
                          <div class="history-item-preview">${preview}</div>
                          <div class="history-item-stats">
                              <div class="history-item-count">
                                  <i class="fas fa-comment"></i>
                                  ${session.messageCount} messages
                              </div>
                              <div class="history-item-actions">
                                  <button class="history-action-btn" onclick="event.stopPropagation(); exportSession('${session.id}')" title="Export">
                                      <i class="fas fa-download"></i>
                                  </button>
                                  <button class="history-action-btn" onclick="event.stopPropagation(); deleteSession('${session.id}')" title="Delete">
                                      <i class="fas fa-trash"></i>
                                  </button>
                              </div>
                          </div>
                      </div>
                  `;
              });

              historyHTML += `</div>`;
          });

          historyContent.innerHTML = historyHTML;
      }

      function groupSessionsByDate(sessions) {
          const groups = {};
          const today = new Date();
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);

          sessions.forEach(session => {
              const sessionDate = new Date(session.updatedAt);
              let groupKey;

              if (isSameDay(sessionDate, today)) {
                  groupKey = 'Today';
              } else if (isSameDay(sessionDate, yesterday)) {
                  groupKey = 'Yesterday';
              } else if (sessionDate > new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000)) {
                  groupKey = 'This Week';
              } else if (sessionDate > new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000)) {
                  groupKey = 'This Month';
              } else {
                  groupKey = sessionDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
              }

              if (!groups[groupKey]) {
                  groups[groupKey] = [];
              }
              groups[groupKey].push(session);
          });

          return groups;
      }

      function isSameDay(date1, date2) {
          return date1.getDate() === date2.getDate() &&
                 date1.getMonth() === date2.getMonth() &&
                 date1.getFullYear() === date2.getFullYear();
      }

      function getTimeAgo(date) {
          const now = new Date();
          const diffInSeconds = Math.floor((now - date) / 1000);

          if (diffInSeconds < 60) return 'Just now';
          if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
          if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
          if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;

          return date.toLocaleDateString();
      }

      function getSessionPreview(session) {
          if (session.messages.length === 0) return 'No messages yet';
          const lastMessage = session.messages[session.messages.length - 1];

          // If the last message was an image, use its content (description) for preview
          if (lastMessage.chart_image) {
              const description = lastMessage.content || ''; // Ensure content is a string
              return `Visualization: ${description.substring(0, 50)}${description.length > 50 ? '...' : ''}`;
          }

          // For regular messages, use their content
          const content = lastMessage.content || ''; // Ensure content is a string
          const preview = content.replace(/\*\*(.*?)\*\*/g, '$1').substring(0, 100);
          return preview.length < content.length ? preview + '...' : preview;
      }

      function searchHistory() {
          const searchTerm = document.getElementById('historySearch').value.toLowerCase();

          if (!searchTerm) {
              updateHistoryDisplay();
              return;
          }

          const filteredHistory = chatHistory.filter(session => {
              return session.title.toLowerCase().includes(searchTerm) ||
                     session.messages.some(msg => msg.content.toLowerCase().includes(searchTerm));
          });

          const historyContent = document.getElementById('historyContent');

          if (filteredHistory.length === 0) {
              historyContent.innerHTML = `
                  <div class="history-empty">
                      <i class="fas fa-search"></i>
                      <h3>No Results Found</h3>
                      <p>No conversations match your search term "${searchTerm}".</p>
                  </div>
              `;
              return;
          }

          let historyHTML = '<div class="history-section"><div class="history-section-title">Search Results</div>';

          filteredHistory.forEach(session => {
              const isActive = session.id === currentSessionId;
              const timeAgo = getTimeAgo(new Date(session.updatedAt));
              const preview = getSessionPreview(session);

              historyHTML += `
                  <div class="history-item ${isActive ? 'active' : ''}" onclick="loadSession('${session.id}')">
                      <div class="history-item-header">
                          <div class="history-item-title">${session.title}</div>
                          <div class="history-item-time">${timeAgo}</div>
                      </div>
                      <div class="history-item-preview">${preview}</div>
                      <div class="history-item-stats">
                          <div class="history-item-count">
                              <i class="fas fa-comment"></i>
                              ${session.messageCount} messages
                          </div>
                          <div class="history-item-actions">
                              <button class="history-action-btn" onclick="event.stopPropagation(); exportSession('${session.id}')" title="Export">
                                  <i class="fas fa-download"></i>
                              </button>
                              <button class="history-action-btn" onclick="event.stopPropagation(); deleteSession('${session.id}')" title="Delete">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </div>
                      </div>
                  </div>
              `;
          });

          historyHTML += '</div>';
          historyContent.innerHTML = historyHTML;
      }

      function updateHistoryBadge() {
          const badge = document.getElementById('historyBadge');
          badge.textContent = chatHistory.length;
      }

      function exportSession(sessionId) {
          const session = chatHistory.find(s => s.id === sessionId);
          if (!session) return;

          let exportText = `Biz Center - Chat Session Export\n`;
          exportText += `Session: ${session.title}\n`;
          exportText += `Created: ${new Date(session.createdAt).toLocaleString()}\n`;
          exportText += `Updated: ${new Date(session.updatedAt).toLocaleString()}\n`;
          exportText += `Messages: ${session.messageCount}\n`;
          exportText += '='.repeat(60) + '\n\n';

          session.messages.forEach((message, index) => {
              const role = message.role === 'user' ? 'User' : 'AI Assistant';
              if (message.chart_image) {
                  // Use message.content for description in export
                  const description = message.content || '';
                  exportText += `[${index + 1}] ${role} (Visualization):\n${description}\n[Image Data (first 50 chars): ${message.chart_image.substring(0, 50)}...]\n\n`;
              } else {
                  exportText += `[${index + 1}] ${role}:\n${message.content}\n\n`;
              }
          });

          exportText += '='.repeat(60) + '\n';
          exportText += `Export Date: ${new Date().toLocaleString()}\n`;

          const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `biz-center-session-${sessionId}-${new Date().toISOString().split('T')[0]}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showNotification('Session exported successfully!', 'success');
      }

      function exportAllHistory() {
          if (chatHistory.length === 0) {
              showNotification('No history to export', 'error');
              return;
          }

          let exportText = `Biz Center - Complete Chat History Export\n`;
          exportText += `Export Date: ${new Date().toLocaleString()}\n`;
          exportText += `Total Sessions: ${chatHistory.length}\n`;
          exportText += `Total Messages: ${messageCount}\n`;
          exportText += '='.repeat(80) + '\n\n';

          chatHistory.forEach((session, sessionIndex) => {
              exportText += `SESSION ${sessionIndex + 1}: ${session.title}\n`;
              exportText += `Created: ${new Date(session.createdAt).toLocaleString()}\n`;
              exportText += `Updated: ${new Date(session.updatedAt).toLocaleString()}\n`;
              exportText += `Messages: ${session.messageCount}\n`;
              exportText += '-'.repeat(60) + '\n\n';

              session.messages.forEach((message, messageIndex) => {
                  const role = message.role === 'user' ? 'User' : 'AI Assistant';
                  if (message.chart_image) {
                      // Use message.content for description in export
                      const description = message.content || '';
                      exportText += `[${messageIndex + 1}] ${role} (Visualization):\n${description}\n[Image Data (first 50 chars): ${message.chart_image.substring(0, 50)}...]\n\n`;
                  } else {
                      exportText += `[${messageIndex + 1}] ${role}:\n${message.content}\n\n`;
                  }
              });

              exportText += '='.repeat(80) + '\n\n';
          });

          const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `biz-center-complete-history-${new Date().toISOString().split('T')[0]}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showNotification('Complete history exported successfully!', 'success');
      }

      function clearAllHistory() {
          if (chatHistory.length === 0) {
              showNotification('No history to clear', 'error');
              return;
          }

          if (confirm('Are you sure you want to delete all chat history? This action cannot be undone.')) {
              chatHistory = [];
              sessionCount = 0;
              document.getElementById('sessionCount').textContent = sessionCount;
              saveData();
              updateHistoryDisplay();
              updateHistoryBadge();

              // Create new session
              newChat();

              showNotification('All history cleared successfully', 'success');
          }
      }

      function showWelcomeMessage() {
          setTimeout(() => {
              const welcomeDiv = document.querySelector('.welcome-message');
              if (welcomeDiv) {
                  welcomeDiv.remove();
                  appendMessage('bot', 'Hello! Welcome to **Biz Center**. I\'m your AI business intelligence assistant. I can help you analyze data, generate insights, answer questions about your business metrics, and much more. What would you like to explore today?');
              }
          }, 2000);
      }

      // Sidebar functions
      function toggleSidebar() {
          const sidebar = document.getElementById('sidebar');
          const overlay = document.getElementById('sidebarOverlay');

          sidebar.classList.toggle('open');
          overlay.classList.toggle('active');
      }

      function closeSidebar() {
          const sidebar = document.getElementById('sidebar');
          const overlay = document.getElementById('sidebarOverlay');

          sidebar.classList.remove('open');
          overlay.classList.remove('active');
      }

      function setActiveMenu(element, menuType) {
          // Remove active class from all menu items
          document.querySelectorAll('.menu-item').forEach(item => {
              item.classList.remove('active');
          });

          // Add active class to clicked item
          element.classList.add('active');
          currentActiveMenu = menuType;

          // Handle different menu actions
          handleMenuAction(menuType);

          // Close sidebar on mobile after selection
          if (window.innerWidth <= 768) {
              closeSidebar();
          }
      }

      function handleMenuAction(menuType) {
          switch(menuType) {
              case 'chat':
                  // Already in chat mode
                  break;
              case 'analytics':
                  showNotification('Analytics dashboard coming soon!', 'info');
                  break;
              case 'knowledge':
                  showNotification('Knowledge base feature in development', 'info');
                  break;
              case 'upload':
                  attachFile();
                  break;
              case 'export':
                  exportChat();
                  break;
              case 'history':
                  openHistoryPanel();
                  break;
              default:
                  showNotification(`${menuType} feature coming soon!`, 'info');
          }
      }

      // Message functions
      function appendMessage(role, content, isLoading = false, saveToHistory = true) {
          const chatMessages = document.getElementById('chatMessages');

          // Remove welcome message if it exists
          const welcomeMessage = chatMessages.querySelector('.welcome-message');
          if (welcomeMessage) {
              welcomeMessage.remove();
          }
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${role}`;

          const avatarIcon = role === 'user' ? 'fas fa-user' : 'fas fa-robot';
          const avatarClass = role === 'user' ? 'avatar user' : 'avatar bot';

          let messageContent = content;
          if (isLoading) {
              messageContent = `
                  <div class="loading-message">
                      <div class="loading-dots">
                          <div class="loading-dot"></div>
                          <div class="loading-dot"></div>
                          <div class="loading-dot"></div>
                      </div>
                      <span class="loading-text">AI is thinking...</span>
                  </div>
              `;
          } else {
              messageContent = formatContent(content);
          }
          messageDiv.innerHTML = `
              <div class="message-content">
                  <div class="${avatarClass}">
                      <i class="${avatarIcon}"></i>
                  </div>
                  <div class="bubble">${messageContent}</div>
              </div>
          `;
          chatMessages.appendChild(messageDiv);
          scrollToBottom();

          // Save to current session if not loading message
          if (!isLoading && saveToHistory) {
              const messageObj = {
                  role: role,
                  content: content,
                  timestamp: new Date().toISOString()
              };
              currentMessages.push(messageObj);
              updateCurrentSession();
          }

          return messageDiv;
      }

      // New function to append image messages
      function appendImageMessage(imageData, description, saveToHistory = true) {
          const chatMessages = document.getElementById('chatMessages');
          const welcomeMessage = chatMessages.querySelector('.welcome-message');
          if (welcomeMessage) {
              welcomeMessage.remove();
          }

          const messageDiv = document.createElement('div');
          messageDiv.className = `message bot`; // Images are always from the bot

          const avatarIcon = 'fas fa-robot';
          const avatarClass = 'avatar bot';

          // Create the image element with the data URI prefix
          // Assuming PNG, adjust if other formats are possible from your backend
          const imageSrc = `data:image/png;base64,${imageData}`;
          const imageElement = `<img src="${imageSrc}" alt="Visualization" />`;
          const descriptionHtml = description ? `<p>${formatContent(description)}</p>` : '';

          messageDiv.innerHTML = `
              <div class="message-content">
                  <div class="${avatarClass}">
                      <i class="${avatarIcon}"></i>
                  </div>
                  <div class="bubble">
                      ${descriptionHtml}
                      ${imageElement}
                  </div>
              </div>
          `;
          chatMessages.appendChild(messageDiv);
          scrollToBottom();

          if (saveToHistory) {
              const messageObj = {
                  role: 'bot',
                  content: description, // Store description as content
                  chart_image: imageData, // Store image data separately
                  timestamp: new Date().toISOString()
              };
              currentMessages.push(messageObj);
              updateCurrentSession();
          }
      }


      function formatContent(content) {
          // Convert **bold** to <strong>
          let formatted = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

          // Convert markdown tables to HTML
          if (/\|(.+)\|/.test(formatted)) {
              formatted = convertMarkdownTableToHTML(formatted);
          }

          // Convert line breaks
          formatted = formatted.replace(/\n/g, '<br>');

          return formatted;
      }

      function convertMarkdownTableToHTML(mdText) {
          const lines = mdText.trim().split('\n');
          const tableLines = lines.filter(line => line.includes('|'));

          if (tableLines.length < 2) return mdText;

          const headers = tableLines[0].split('|').slice(1, -1).map(h => h.trim());
          const rows = tableLines.slice(2).map(row =>
              row.split('|').slice(1, -1).map(cell => cell.trim())
          );

          let html = '<table>';
          html += '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
          html += '<tbody>';
          rows.forEach(row => {
              html += '<tr>' + row.map(cell => `<td>${cell || ''}</td>`).join('') + '</tr>';
          });
          html += '</tbody></table>';

          return html;
      }

      function scrollToBottom() {
          const chatMessages = document.getElementById('chatMessages');
          chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function sendMessage() {
          const input = document.getElementById('messageInput');
          const sendBtn = document.getElementById('sendBtn');
          const question = input.value.trim();

          if (!question || isLoading) return;

          // Add user message
          appendMessage('user', question);
          input.value = '';
          input.style.height = 'auto';

          // Update counters
          messageCount++;
          document.getElementById('messageCount').textContent = messageCount;
          saveData();

          // Show loading state and stop button
          isLoading = true;
          sendBtn.style.display = 'none';

          // Create stop button
          const stopBtn = document.createElement('button');
          stopBtn.className = 'stop-btn';
          stopBtn.id = 'stopBtn';
          stopBtn.innerHTML = `
      <div class="stop-icon"></div>
      <span>Stop</span>
  `;
          stopBtn.onclick = stopGeneration;

          // Replace send button with stop button
          const inputContainer = document.querySelector('.input-container');
          inputContainer.appendChild(stopBtn);

          const loadingMessage = appendMessage('bot', '', true, false);

          // Create abort controller for this request
          abortController = new AbortController();

          try {
              const response = await fetch('https://ai-api.invoicex.tech/ragpoc-m/query', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ question }),
                  signal: abortController.signal
              });

              if (!response.ok) {
                  throw new Error(`Server error: ${response.status} - ${response.statusText}`);
              }

              const data = await response.json();

              // Remove loading message
              loadingMessage.remove();

              // Check if the response contains a chart image
              if (data.visualization_needed && data.chart_image) {
                  appendImageMessage(data.chart_image, data.answer);
                  showNotification('Visualization created successfully!', 'success');
              } else {
                  const answer = data.answer || 'No answer received from the server.';
                  appendMessage('bot', answer);
                  showNotification('Response received successfully!', 'success');
              }

          } catch (error) {
              // Remove loading message
              loadingMessage.remove();

              if (error.name === 'AbortError') {
                  // Request was aborted
                  appendMessage('bot', ' **Generation Stopped**: Response generation was cancelled by user.');
                  showNotification('Response generation stopped', 'info');
              } else {
                  // Other errors
                  const errorMessage = ` **Connection Error**: ${error.message}\n\nLimit of gemini API is on limit  and try again after sometime .`;
                  appendMessage('bot', errorMessage);
                  showNotification('Failed to connect to AI service', 'error');
              }
          } finally {
              // Reset UI state
              isLoading = false;
              abortController = null;

              // Remove stop button and show send button
              const stopButton = document.getElementById('stopBtn');
              if (stopButton) {
                  stopButton.remove();
              }
              sendBtn.style.display = 'flex';
              sendBtn.disabled = false;
              input.focus();
          }
      }

      function stopGeneration() {
          if (abortController) {
              abortController.abort();
              showNotification('Stopping generation...', 'info');
          }
      }

      // Utility functions
      function exportChat() {
          if (currentMessages.length === 0) {
              showNotification('No messages to export', 'error');
              return;
          }

          const session = chatHistory.find(s => s.id === currentSessionId);
          const sessionTitle = session ? session.title : 'Current Chat';

          let chatText = 'Biz Center - AI Business Intelligence Assistant\n';
          chatText += `Chat Export: ${sessionTitle}\n`;
          chatText += 'Export Date: ' + new Date().toLocaleString() + '\n';
          chatText += '='.repeat(60) + '\n\n';

          currentMessages.forEach((message, index) => {
              const role = message.role === 'user' ? 'User' : 'AI Assistant';
              if (message.chart_image) {
                  // Use message.content for description in export
                  const description = message.content || '';
                  chatText += `[${index + 1}] ${role} (Visualization):\n${description}\n[Image Data (first 50 chars): ${message.chart_image.substring(0, 50)}...]\n\n`;
              } else {
                  chatText += `[${index + 1}] ${role}:\n${message.content}\n\n`;
              }
          });

          chatText += '='.repeat(60) + '\n';
          chatText += `Total Messages: ${currentMessages.length}\n`;
          chatText += `Export Date: ${new Date().toLocaleString()}\n`;

          const blob = new Blob([chatText], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `biz-center-chat-${new Date().toISOString().split('T')[0]}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showNotification('Chat exported successfully!', 'success');
      }

      function attachFile() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.pdf,.doc,.docx,.txt,.csv,.xlsx';
          input.onchange = function(e) {
              const file = e.target.files[0];
              if (file) {
                  showNotification(`File "${file.name}" selected. Upload feature coming soon!`, 'info');
              }
          };
          input.click();
      }

      async function toggleVoice() {
      const voiceBtn = document.querySelector('.input-action-btn[title="Voice input"]');
      const messageInput = document.getElementById('messageInput');

      if (!isRecording) {
          // Start recording
          try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              mediaRecorder = new MediaRecorder(stream);
              audioChunks = [];

              mediaRecorder.ondataavailable = event => {
                  audioChunks.push(event.data);
              };

              mediaRecorder.onstop = async () => {
                  const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                  
                  recordingStatusElement.style.display = 'flex';
                  recordingStatusElement.querySelector('span').textContent = 'Processing audio...';
                  recordingStatusElement.querySelector('i').className = 'fas fa-spinner fa-spin';

                  try {
                      const formData = new FormData();
                      formData.append('audio_file', audioBlob, 'recording.webm');

                      const response = await fetch('https://ai-api.invoicex.tech/ragpoc-m/transcribe', { // Ensure this URL matches your backend
                          method: 'POST',
                          body: formData,
                      });

                      if (!response.ok) {
                          throw new Error(`Transcription server error: ${response.status} - ${response.statusText}`);
                      }

                      const data = await response.json();
                      const transcribedText = data.transcribed_text;

                      if (transcribedText) {
                          messageInput.value = transcribedText;
                          showNotification('Audio transcribed successfully!', 'success');
                          // REMOVED: sendMessage(); // No longer automatically send the transcribed text
                      } else {
                          showNotification('No text transcribed. Please try again.', 'error');
                      }
                  } catch (error) {
                      console.error('Error during transcription:', error);
                      showNotification(`Transcription failed: ${error.message}`, 'error');
                      appendMessage('bot', ` **Voice Input Error**: ${error.message}`);
                  } finally {
                      recordingStatusElement.style.display = 'none';
                      // Stop all tracks in the stream to release microphone
                      stream.getTracks().forEach(track => track.stop());
                  }
              };

              mediaRecorder.start();
              isRecording = true;
              voiceBtn.innerHTML = '<i class="fas fa-stop-circle"></i>'; // Change icon to stop
              showNotification('Recording started...', 'info');
              recordingStatusElement.style.display = 'flex';
              recordingStatusElement.querySelector('span').textContent = 'Recording...';
              recordingStatusElement.querySelector('i').className = 'fas fa-microphone-alt';

          } catch (err) {
              console.error('Error accessing microphone:', err);
              showNotification('Could not access microphone. Please allow microphone access.', 'error');
          }
      } else {
          // Stop recording
          if (mediaRecorder && mediaRecorder.state === 'recording') {
              mediaRecorder.stop();
              isRecording = false;
              voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>'; // Change icon back to microphone
              showNotification('Recording stopped. Processing...', 'info');
          }
      }
  }

      function toggleSettings() {
          showNotification('Settings panel coming soon!', 'info');
      }

      function showNotification(message, type = 'info') {
          const container = document.getElementById('notificationContainer');
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.textContent = message;

          container.appendChild(notification);

          // Show notification
          setTimeout(() => {
              notification.classList.add('show');
          }, 100);

          // Hide and remove notification
          setTimeout(() => {
              notification.classList.remove('show');
              setTimeout(() => {
                  if (container.contains(notification)) {
                      container.removeChild(notification);
                  }
              }, 300);
          }, 3000);
      }

      // Initialize welcome message and focus
      setTimeout(() => {
          document.getElementById('messageInput').focus();
      }, 1000);
  </script>
</body>
</html>
